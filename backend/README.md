# Backend –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

Backend –Ω–∞ FastAPI –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ML-–º–æ–¥–µ–ª–∏, –æ–±—Ä–∞–±–æ—Ç–∫–æ–π CSV —Ñ–∞–π–ª–æ–≤, batch-–∏–Ω—Ñ–µ—Ä–µ–Ω—Å–æ–º –∏ –ø–æ–¥—Å—á–µ—Ç–æ–º –º–µ—Ç—Ä–∏–∫ –∫–∞—á–µ—Å—Ç–≤–∞.

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (Docker)

### –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose

1. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
   ```bash
   cp .env.example .env
   ```

2. **–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env` —Ñ–∞–π–ª** (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã:**
   ```bash
   docker-compose up -d
   ```
   
   –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É API:**
   - API: http://localhost:8000
   - Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:8000/docs
   - Health check: http://localhost:8000/api/health

**–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤:**
```bash
docker-compose down
```

### –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ Backend —á–µ—Ä–µ–∑ Docker

–ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å PostgreSQL:

1. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.example` –≤ `.env` –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:**
   ```bash
   cp .env.example .env
   ```

2. **–°–æ–±–µ—Ä–∏—Ç–µ –æ–±—Ä–∞–∑:**
   ```bash
   cd backend
   docker build -t hack-change-backend .
   ```

3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:**
   ```bash
   docker run -p 8000:8000 --env-file .env hack-change-backend
   ```
   
   –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.example` –≤ `.env` –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|----------------------|
| `DATABASE_URL` | URL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL | `postgresql+asyncpg://postgres:postgres@localhost:5432/hack_change` |
| `MODEL_PATH` | –ü—É—Ç—å –∫ ML-–º–æ–¥–µ–ª–∏ | `models/sentiment_model` |
| `BATCH_SIZE` | –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ | `32` |
| `DEBUG` | –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ | `True` |

**–î–ª—è Docker Compose:** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `db` –≤–º–µ—Å—Ç–æ `localhost` –≤ `DATABASE_URL`.

---

## üîå API –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### Health Check

**GET** `/api/health`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "ok",
  "database": "up"
}
```

### –ê–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

**POST** `/api/analyze`

–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "text": "–≠—Ç–æ –æ—Ç–ª–∏—á–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç!"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "label": 2,
  "confidence": 0.85
}
```

### –ó–∞–≥—Ä—É–∑–∫–∞ CSV

**POST** `/api/upload`

–ó–∞–≥—Ä—É–∂–∞–µ—Ç CSV —Ñ–∞–π–ª –∏ —Å–æ–∑–¥–∞–µ—Ç —Å–µ—Å—Å–∏—é –∞–Ω–∞–ª–∏–∑–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `file` (form-data): CSV —Ñ–∞–π–ª —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –∫–æ–ª–æ–Ω–∫–æ–π `text`
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: `source`, `label` (true_label)

**–ü—Ä–∏–º–µ—Ä CSV:**
```csv
text,source,label
"–û—Ç–ª–∏—á–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç!",review,2
"–ù–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å",review,0
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "session_id": 1,
  "filename": "data.csv",
  "rows_count": 2
}
```

### Batch-–æ–±—Ä–∞–±–æ—Ç–∫–∞

**POST** `/api/batch-analyze?session_id=1`

–í—ã–ø–æ–ª–Ω—è–µ—Ç –±–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤ –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ CSV.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `session_id` (query): ID —Å–µ—Å—Å–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ CSV

**–û—Ç–≤–µ—Ç:**
```json
{
  "session_id": 1,
  "processed_count": 2
}
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è (—Ä–∞—Å—á–µ—Ç macro-F1)

**POST** `/api/validate?session_id=1`

–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç macro-F1 –º–µ—Ç—Ä–∏–∫—É –¥–ª—è —Å–µ—Å—Å–∏–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `session_id` (query): ID —Å–µ—Å—Å–∏–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–û—Ç–≤–µ—Ç:**
```json
{
  "macro_f1": 0.85,
  "class_metrics": [
    {
      "class_label": 0,
      "precision": 0.90,
      "recall": 0.85,
      "f1": 0.87
    },
    {
      "class_label": 1,
      "precision": 0.80,
      "recall": 0.75,
      "f1": 0.77
    },
    {
      "class_label": 2,
      "precision": 0.90,
      "recall": 0.95,
      "f1": 0.92
    }
  ]
}
```

### –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**GET** `/api/export-csv?session_id=1`

–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —Å–µ—Å—Å–∏–∏ –≤ CSV —Ñ–æ—Ä–º–∞—Ç.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `session_id` (query): ID —Å–µ—Å—Å–∏–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞

**–û—Ç–≤–µ—Ç:**
```json
{
  "csv": "text,pred_label,confidence,source,true_label\n\"–û—Ç–ª–∏—á–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç!\",2,0.85,review,2\n..."
}
```

---

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **FastAPI** - –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **SQLAlchemy** (async) - ORM –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
- **PostgreSQL** - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Alembic** - –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
- **Pandas** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ CSV
- **scikit-learn** - —Ä–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫ (macro-F1)
- **NumPy** - —á–∏—Å–ª–µ–Ω–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
backend/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.py          # API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ db.py              # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –∏ lifespan
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py            # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –º–æ–¥–µ–ª–µ–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ analysis.py        # –ú–æ–¥–µ–ª–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
‚îÇ   ‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ analysis.py        # Pydantic —Å—Ö–µ–º—ã
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ csv_service.py     # –û–±—Ä–∞–±–æ—Ç–∫–∞ CSV
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ metrics_service.py # –†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ml_service.py      # ML-–º–æ–¥–µ–ª—å
‚îÇ   ‚îî‚îÄ‚îÄ main.py                # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ alembic/                   # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
‚îú‚îÄ‚îÄ requirements.txt           # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îî‚îÄ‚îÄ Dockerfile                 # Docker –æ–±—Ä–∞–∑
```

---

## üóÑ –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

### AnalysisSession
- `id` - ID —Å–µ—Å—Å–∏–∏
- `created_at` - –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
- `filename` - –ò–º—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

### TextAnalysis
- `id` - ID –∑–∞–ø–∏—Å–∏
- `session_id` - ID —Å–µ—Å—Å–∏–∏
- `text` - –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- `pred_label` - –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Å (0, 1, 2)
- `confidence` - –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ (0.0-1.0)
- `source` - –ò—Å—Ç–æ—á–Ω–∏–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `true_label` - –ò—Å—Ç–∏–Ω–Ω—ã–π –∫–ª–∞—Å—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## –ú–µ—Ç—Ä–∏–∫–∏

Macro-F1 —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ñ–æ—Ä–º—É–ª–µ:
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞ i ‚àà {0, 1, 2}:
  - Precision_i = TP_i / (TP_i + FP_i)
  - Recall_i = TP_i / (TP_i + FN_i)
  - F1_i = 2 * (Precision_i * Recall_i) / (Precision_i + Recall_i)
- Macro-F1 = (F1_0 + F1_1 + F1_2) / 3

---

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∞ ML-–º–æ–¥–µ–ª–∏ (—Å–ª—É—á–∞–π–Ω—ã–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è)
- –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:
  1. –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `models/`
  2. –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–æ–¥ `load_model()` –≤ `MLService`
  3. –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã `predict()` –∏ `predict_batch()`

---

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

**–ú–∏–≥—Ä–∞—Ü–∏–∏:**
```bash
# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
alembic revision --autogenerate -m "–æ–ø–∏—Å–∞–Ω–∏–µ"

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head

# –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
alembic downgrade -1
```

**Docker:**
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker-compose logs -f backend

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
docker-compose restart backend

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
docker-compose exec backend <–∫–æ–º–∞–Ω–¥–∞>
```
